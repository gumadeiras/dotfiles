#!/usr/bin/env bash

# Office Quotes CLI - The Office quote generator
# Offline mode: local JSON (326 quotes)
# Online mode: akash API (SVG cards + avatars + episode data)

SCRIPT_DIR="${0%/*}"
DATA_FILE="$SCRIPT_DIR/data/quotes.json"
API_BASE="https://officeapi.akashrajpurohit.com"

show_help() {
  cat <<'EOF'
office-quotes - The Office quote generator

Usage: office-quotes [command] [options]

Commands (Online + Offline):
  random              Show a random quote (default)
  shuffle             Another random quote
  list [character]    List all local quotes, optionally by character
  characters          List all characters (local)
  count               Show quote count
  search <query>      Search quotes (local)
  api [random|json]   Fetch from online API (SVG cards + metadata)

Options:
  -h, --help          Show this help
  -q, --quiet         Quote only (local, no character)
  --image             Get SVG image URL (online mode)
  --episode S/E       Get episode metadata (e.g., --episode 3/10)
  --light             Use light theme for SVG (default: dark)
  --width <px>        SVG width (default: 400)
  --height <px>       SVG height (default: 200)

Examples:
  office-quotes                     # Random local quote
  office-quotes random              # Same
  office-quotes -q                  # Quote only
  office-quotes list dwight         # Dwight quotes
  office-quotes search "bears"      # Search local quotes
  office-quotes api random          # Random + SVG card
  office-quotes api random --image  # Get SVG image URL
  office-quotes --episode 3/10      # Episode S3E10 metadata
  office-quotes api random --light  # Light theme SVG

EOF
}

# Local mode functions
random_quote_local() {
  local count
  count=$(jq 'length' "$DATA_FILE")
  local index=$((RANDOM % count))
  jq -r ".[$index] | \"\(.character): \(.content)\"" "$DATA_FILE"
}

list_quotes_local() {
  local char="${1:-}"
  if [[ -n "$char" ]]; then
    jq -r --arg c "$char" '.[] | select(.character | test($c; "i")) | "\(.character): \(.content)"' "$DATA_FILE"
  else
    jq -r '.[] | "\(.character): \(.content)"' "$DATA_FILE"
  fi
}

list_characters_local() {
  jq -r '[.[] | .character] | unique | .[]' "$DATA_FILE" | sort | uniq
}

count_quotes_local() {
  local count
  count=$(jq 'length' "$DATA_FILE")
  echo "Local: $count quotes"
}

search_quotes_local() {
  local query="${1:-}"
  if [[ -z "$query" ]]; then
    echo "Usage: office-quotes search <query>"
    return 1
  fi
  jq -r --arg q "$query" '.[] | select(.content | test($q; "i")) | "[\(.character)]: \(.content)"' "$DATA_FILE"
}

# Online API functions
fetch_api_random() {
  local mode="dark"
  local width=400
  local height=200
  local get_url=false
  
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --light) mode="light"; shift ;;
      --width) width="$2"; shift 2 ;;
      --height) height="$2"; shift 2 ;;
      --image) get_url=true; shift ;;
      *) shift ;;
    esac
  done
  
  local url="${API_BASE}/quote/random?responseType=svg&mode=${mode}&width=${width}&height=${height}"
  
  if [[ "$get_url" == "true" ]]; then
    echo "$url"
  else
    curl -s "$url" 2>/dev/null || echo "Error: Could not fetch from API"
  fi
}

fetch_api_random_json() {
  curl -s "${API_BASE}/quote/random?responseType=json" 2>/dev/null | jq '.' 2>/dev/null || echo '{"error": "API unavailable"}'
}

fetch_episode() {
  local season="${1:-1}"
  local episode="${2:-1}"
  curl -s "${API_BASE}/season/${season}/episode/${episode}" 2>/dev/null | jq '.' 2>/dev/null || echo '{"error": "Episode not found"}'
}

fetch_season() {
  local season="${1:-1}"
  curl -s "${API_BASE}/season/${season}" 2>/dev/null | jq '.' 2>/dev/null || echo '{"error": "Season not found"}'
}

# Parse arguments
if [[ $# -eq 0 ]]; then
  random_quote_local
  exit 0
fi

case "$1" in
  -h|--help)
    show_help
    ;;
  -q|--quiet)
    count=$(jq 'length' "$DATA_FILE")
    index=$((RANDOM % count))
    jq -r ".[$index].content" "$DATA_FILE"
    ;;
  random|shuffle)
    random_quote_local
    ;;
  list)
    list_quotes_local "${2:-}"
    ;;
  characters)
    list_characters_local
    ;;
  count)
    count_quotes_local
    ;;
  search)
    search_quotes_local "${2:-}"
    ;;
  api)
    case "${2:-random}" in
      random)
        fetch_api_random "${@:3}"
        ;;
      json)
        fetch_api_random_json
        ;;
      *)
        echo "Unknown api mode: $2"
        echo "Usage: office-quotes api [random|json]"
        ;;
    esac
    ;;
  --image)
    fetch_api_random --image "${@:2}"
    ;;
  --episode)
    if [[ "$2" =~ ^([0-9]+)/([0-9]+)$ ]]; then
      fetch_episode "${BASH_REMATCH[1]}" "${BASH_REMATCH[2]}"
    else
      echo "Usage: office-quotes --episode S/E (e.g., 3/10)"
    fi
    ;;
  --season)
    fetch_season "${2:-1}"
    ;;
  *)
    echo "Unknown command: $1"
    echo "Run 'office-quotes --help' for usage"
    exit 1
    ;;
esac
